#!/bin/bash
if [ -z "$scenario" ]; then 
   # try to get from cmd args
   scenario=$1
   ddate=$2
   tempdir=$3
fi
export scenario ddate tempdir

if [ -z "$scenario" ]; then 
  echo "Error: missing Arguments."
  echo "Script must be called as: 'script_name scenario date [temp dir]'"
  echo "Ex: $0 PRISM 2020-01-18"
  exit
fi

# Need date. Met runs on a single day basis and user must supply date.
if [ -z ${ddate+x} ]; then 
  echo "Error: missing Arguments."
  echo "Script must be called as: 'script_name scenario date [temp dir]'"
  exit
fi

# create temp dir
if [ ! -d "$tempdir" ]; then
  mkdir $tempdir
fi
echo "Changing to working dir: $tempdir"
cd $tempdir

# loads the base database specific config to get the db_host
db_config=`find_config db.config`
if [ "$db_config" = "" ]; then
  db_config="$META_MODEL_ROOT/models/raster_met/db.config"
fi
. $db_config
export db_host

# Load simulation basics (need start date and translated datasource for raster.config)
START_DATE=`cbp get_config $scenario met START_DATE`

# the selected analysis model is set as a variable i
GEO_MET_MODEL=`cbp get_config $scenario met GEO_MET_MODEL`
MET_DATA_SOURCE=`cbp get_config $scenario met MET_DATA_SOURCE`


MET_SCRIPT_PATH="/opt/model/model_meteorology"

#DB Files:
RASTER_SQL_FILE="${tempdir}/${coverage}-${MET_DATA_SOURCE}-all.csv.sql"
RASTER_SUM_FILE="/tmp/${coverage}-${MET_DATA_SOURCE}-all.csv"

# Now, construct other variables given scenario config and arguments
RATING_FILE="$MET_EXPORT_DIR/${scenario}/out/${coverage}-${MET_DATA_SOURCE}-${GEO_MET_MODEL}-ratings.csv"
RATING_TS_FILE="$MET_EXPORT_DIR/${scenario}/out/${coverage}-${MET_DATA_SOURCE}-${GEO_MET_MODEL}-rating-ts.csv"



export RASTER_SQL_FILE RASTER_SUM_FILE
export MET_SCRIPT_PATH MET_DATA_SOURCE MET_EXPORT_DIR GEO_MET_MODEL COVERAGE_PRECIP_FILE COVERAGE_FLOW_FILE WEEKLY_PRECIP_FILE 
export USGS_GAGE OBS_FLOW_FILE DAILY_PRECIP_FILE MODEL_JSON MODEL_STATS 
export RATING_TS_FILE RATING_FILE
export STORM_EVENT_FLOW_FILE STORM_EVENT_STATS_FILE STORM_EVENT_PLOT_DIR STORM_EVENT_PRECIP_PLOT_DIR
export SEARCH_ALL_STORM BASELINE_FLOW_METHOD STORM_INCLUDE_DURATION STORMSEP_REGRESSION_METHOD STORMSEP_PLOT